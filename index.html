<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC-QR Mapper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
            /* Core system colors - optimized for OLED displays */
            --black-base: #171717;
            --black-surface: #1c1c1c;
            --black-elevated: #242424;
            --black-active: #2a2a2a;
            
            /* Text hierarchy - WCAG AAA compliant */
            --text-primary: rgba(255, 255, 255, 0.87);
            --text-secondary: rgba(255, 255, 255, 0.60);
            --text-tertiary: rgba(255, 255, 255, 0.38);
            
            /* Interactive colors */
            --accent: #7c7fff;       /* Primary action color */
            --accent-hover: #6e6ee5;  /* Darker state for hover */
            
            /* Status indicators */
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            
            /* Layout grid */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 16px;
            --space-4: 24px;
            
            /* System properties */
            --radius: 8px;
            --transition: 200ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--black-base);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: var(--space-3);
        }

        h1 {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: var(--space-4);
            text-align: center;
        }

        .scan-section {
            background: var(--black-surface);
            border-radius: var(--radius);
            padding: var(--space-3);
            margin-bottom: var(--space-3);
        }

        h2 {
            font-size: 14px;
            font-weight: normal;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        button {
            width: 100%;
            padding: var(--space-3);
            background: var(--black-elevated);
            color: var(--text-primary);
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            cursor: pointer;
            transition: background var(--transition);
            min-height: 48px;
            margin-bottom: var(--space-2);
        }

        button:active {
            background: var(--black-active);
        }

        .status {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius);
            font-size: 14px;
            background: var(--black-elevated);
            margin-bottom: var(--space-2);
        }

        .status.success { color: var(--success); }
        .status.warning { color: var(--warning); }
        .status.error { color: var(--error); }

        #reader {
            background: var(--black-surface);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: var(--space-2);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            margin-top: var(--space-3);
        }

        th, td {
            padding: var(--space-3);
            text-align: left;
            border-bottom: 1px solid var(--black-elevated);
        }

        th {
            color: var(--text-secondary);
            font-weight: normal;
        }

        td button {
            width: 32px;
            height: 32px;
            min-height: unset;
            padding: 0;
            margin: 0;
            background: var(--error);
            opacity: 0.8;
        }

        /* QR Scanner Overrides */
        #reader * {
            background: var(--black-surface) !important;
            color: var(--text-primary) !important;
            border-color: var(--black-elevated) !important;
        }

        #reader img[alt="Info icon"] {
            display: none;
        }

        @media (min-width: 640px) {
            .scan-container {
                display: flex;
                gap: var(--space-3);
            }

            .scan-section {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NFC-QR Mapper</h1>
        
        <div class="scan-container">
            <div class="scan-section">
                <h2>1. NFC Tag</h2>
                <button id="nfcButton">Start NFC Scan</button>
                <div id="nfcStatus" class="status"></div>
            </div>
            
            <div class="scan-section">
                <h2>2. QR Code</h2>
                <div id="reader"></div>
                <div id="qrStatus" class="status"></div>
            </div>
        </div>

        <div class="scan-section">
            <button id="exportButton">Export CSV</button>
            <button id="clearButton">Clear All</button>

            <table>
                <thead>
                    <tr>
                        <th>NFC ID</th>
                        <th>QR Code</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="mappingTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        class NFCQRMapper {
            constructor() {
                this.mappings = new Map();
                this.currentNFCSerial = null;
                this.html5QrCode = new Html5Qrcode("reader");
                this.setupEventListeners();
                this.loadFromLocalStorage();
                this.renderTable();
            }

            setupEventListeners() {
                document.getElementById('nfcButton').addEventListener('click', () => this.startNFCScan());
                document.getElementById('exportButton').addEventListener('click', () => this.exportCSV());
                document.getElementById('clearButton').addEventListener('click', () => this.clearAll());
                this.setupQRScanner();
            }

            async startNFCScan() {
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    this.updateStatus('nfcStatus', 'Ready to scan...', 'waiting');
                    
                    ndef.addEventListener("reading", ({ serialNumber }) => {
                        this.currentNFCSerial = serialNumber;
                        this.updateStatus('nfcStatus', `NFC: ${serialNumber.slice(-8)}`, 'success');
                        this.startQRScan();
                        // Haptic feedback
                        if (navigator.vibrate) {
                            navigator.vibrate(200);
                        }
                    });
                } catch (error) {
                    this.updateStatus('nfcStatus', 'NFC failed: ' + error, 'error');
                }
            }

            setupQRScanner() {
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                };

                this.html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    this.handleQRCode.bind(this)
                );
            }

            startQRScan() {
                this.updateStatus('qrStatus', 'Scan QR...', 'waiting');
            }

            handleQRCode(qrCode) {
                if (this.currentNFCSerial) {
                    this.mappings.set(this.currentNFCSerial, qrCode);
                    this.updateStatus('qrStatus', `Paired ✓`, 'success');
                    this.saveToLocalStorage();
                    this.renderTable();
                    
                    // Strong haptic feedback for successful pair
                    if (navigator.vibrate) {
                        navigator.vibrate([200, 100, 200]);
                    }
                    
                    // Auto-continue
                    this.currentNFCSerial = null;
                    setTimeout(() => this.startNFCScan(), 1000);
                }
            }

            deleteMapping(nfcSerial) {
                this.mappings.delete(nfcSerial);
                this.saveToLocalStorage();
                this.renderTable();
            }

            renderTable() {
                const tbody = document.getElementById('mappingTable');
                tbody.innerHTML = '';
                
                for (const [nfc, qr] of this.mappings) {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = nfc.slice(-8);
                    row.insertCell(1).textContent = qr;
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = '×';
                    deleteButton.onclick = () => this.deleteMapping(nfc);
                    row.insertCell(2).appendChild(deleteButton);
                }
            }

            exportCSV() {
                let csv = 'NFC Serial,QR Code\n';
                for (const [nfc, qr] of this.mappings) {
                    csv += `${nfc},${qr}\n`;
                }
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'nfc-qr-mappings.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }

            clearAll() {
                if (confirm('Clear all mappings?')) {
                    this.mappings.clear();
                    this.saveToLocalStorage();
                    this.renderTable();
                }
            }

            updateStatus(elementId, message, type) {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.className = `status ${type}`;
            }

            saveToLocalStorage() {
                localStorage.setItem('nfcQrMappings', JSON.stringify(Array.from(this.mappings.entries())));
            }

            loadFromLocalStorage() {
                const stored = localStorage.getItem('nfcQrMappings');
                if (stored) {
                    this.mappings = new Map(JSON.parse(stored));
                }
            }
        }

        // Initialize application
        const mapper = new NFCQRMapper();
    </script>
</body>
</html>
