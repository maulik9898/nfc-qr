<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC-QR Mapper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 20px;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .scan-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .scan-section {
            flex: 1;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        #reader {
            width: 100%;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; }
        .waiting { background-color: #fff3cd; }
        .error { background-color: #f8d7da; }
    </style>
</head>
<body>
    <h1>NFC-QR Mapper</h1>
    
    <div class="scan-container">
        <div class="scan-section">
            <h2>Step 1: Scan NFC</h2>
            <button id="nfcButton">Start NFC Scan</button>
            <div id="nfcStatus" class="status"></div>
        </div>
        <div class="scan-section">
            <h2>Step 2: Scan QR</h2>
            <div id="reader"></div>
            <div id="qrStatus" class="status"></div>
        </div>
    </div>

    <div>
        <button id="exportButton">Export CSV</button>
        <button id="clearButton">Clear All</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>NFC Serial</th>
                <th>QR Code</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="mappingTable"></tbody>
    </table>

    <script>
        class NFCQRMapper {
            constructor() {
                this.mappings = new Map();
                this.currentNFCSerial = null;
                this.html5QrCode = new Html5Qrcode("reader");
                this.setupEventListeners();
                this.loadFromLocalStorage();
                this.renderTable();
            }

            setupEventListeners() {
                document.getElementById('nfcButton').addEventListener('click', () => this.startNFCScan());
                document.getElementById('exportButton').addEventListener('click', () => this.exportCSV());
                document.getElementById('clearButton').addEventListener('click', () => this.clearAll());
                this.setupQRScanner();
            }

            async startNFCScan() {
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    this.updateStatus('nfcStatus', 'Scanning for NFC tag...', 'waiting');
                    
                    ndef.addEventListener("reading", ({ serialNumber }) => {
                        this.currentNFCSerial = serialNumber;
                        this.updateStatus('nfcStatus', `NFC detected: ${serialNumber}`, 'success');
                        this.startQRScan();
                    });
                } catch (error) {
                    this.updateStatus('nfcStatus', 'NFC scan failed: ' + error, 'error');
                }
            }

            setupQRScanner() {
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                };

                this.html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    this.handleQRCode.bind(this)
                );
            }

            startQRScan() {
                this.updateStatus('qrStatus', 'Ready to scan QR code...', 'waiting');
            }

            handleQRCode(qrCode) {
                if (this.currentNFCSerial) {
                    this.mappings.set(this.currentNFCSerial, qrCode);
                    this.updateStatus('qrStatus', `Mapped: ${this.currentNFCSerial} â†’ ${qrCode}`, 'success');
                    this.saveToLocalStorage();
                    this.renderTable();
                    this.currentNFCSerial = null;
                }
            }

            deleteMapping(nfcSerial) {
                this.mappings.delete(nfcSerial);
                this.saveToLocalStorage();
                this.renderTable();
            }

            renderTable() {
                const tbody = document.getElementById('mappingTable');
                tbody.innerHTML = '';
                
                for (const [nfc, qr] of this.mappings) {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = nfc;
                    row.insertCell(1).textContent = qr;
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.onclick = () => this.deleteMapping(nfc);
                    row.insertCell(2).appendChild(deleteButton);
                }
            }

            exportCSV() {
                let csv = 'NFC Serial,QR Code\n';
                for (const [nfc, qr] of this.mappings) {
                    csv += `${nfc},${qr}\n`;
                }
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'nfc-qr-mappings.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }

            clearAll() {
                if (confirm('Are you sure you want to clear all mappings?')) {
                    this.mappings.clear();
                    this.saveToLocalStorage();
                    this.renderTable();
                }
            }

            updateStatus(elementId, message, type) {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.className = `status ${type}`;
            }

            saveToLocalStorage() {
                localStorage.setItem('nfcQrMappings', JSON.stringify(Array.from(this.mappings.entries())));
            }

            loadFromLocalStorage() {
                const stored = localStorage.getItem('nfcQrMappings');
                if (stored) {
                    this.mappings = new Map(JSON.parse(stored));
                }
            }
        }

        // Initialize the application
        const mapper = new NFCQRMapper();
    </script>
</body>
</html>
